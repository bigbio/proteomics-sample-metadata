= SDRF-Proteomics Template Definitions Guide
:toc: left
:toc-title: Contents
:toclevels: 3
:icons: font
:source-highlighter: highlight.js
:sectnums:

== Introduction

This document describes the technical implementation of SDRF-Proteomics templates for **developers and maintainers**. Templates are implemented as YAML files that define validation rules, column requirements, and inheritance relationships.

These YAML definitions are used by the https://github.com/bigbio/sdrf-pipelines[sdrf-pipelines] validator to check SDRF files for compliance.

**Template files location:** https://github.com/bigbio/proteomics-metadata-standard/tree/master/sdrf-proteomics/templates[sdrf-proteomics/templates/]

== Template Architecture

=== Layered Hierarchy

Templates are organized in a layered hierarchy where each layer serves a specific purpose:

[source]
----
base (construction artifact - not user-facing)
│
├── TECHNOLOGY LAYER (mutually exclusive)
│   ├── ms-proteomics              # Mass spectrometry proteomics
│   │   └── EXPERIMENT LAYER
│   │       ├── dda-acquisition    # Data-dependent acquisition
│   │       ├── dia-acquisition    # Data-independent acquisition
│   │       ├── single-cell        # Single-cell proteomics
│   │       ├── immunopeptidomics  # MHC peptide analysis
│   │       ├── crosslinking       # XL-MS experiments
│   │       └── metaproteomics     # Microbiome proteomics
│   │
│   └── affinity-proteomics        # Affinity-based proteomics
│       └── EXPERIMENT LAYER
│           ├── olink              # Olink PEA platform
│           └── somascan           # SomaScan aptamer platform
│
└── SAMPLE LAYER (mutually exclusive)
    ├── human                      # Human samples
    ├── vertebrates                # Non-human vertebrates (mouse, rat, etc.)
    ├── invertebrates              # Invertebrates (Drosophila, C. elegans)
    └── plants                     # Plant samples (Arabidopsis, crops)

cell-lines (EXPERIMENT layer - requires technology + sample)
----

=== Layer Definitions

[cols="1,3,2", options="header"]
|===
| Layer | Purpose | Examples

| `base`
| Internal construction artifact with shared columns. Never used directly by users.
| base

| `technology`
| Defines the proteomics technology. Exactly one required per SDRF.
| ms-proteomics, affinity-proteomics

| `sample`
| Defines organism-specific sample metadata. One recommended per SDRF.
| human, vertebrates, invertebrates, plants

| `experiment`
| Defines methodology-specific columns. Multiple can be combined if not mutually exclusive.
| dda-acquisition, single-cell, olink, cell-lines
|===

=== Mutual Exclusivity

Some templates cannot be combined because they represent mutually exclusive concepts:

[cols="2,2,3", options="header"]
|===
| Template A | Template B | Reason

| ms-proteomics | affinity-proteomics | Different technologies
| dda-acquisition | dia-acquisition | Different acquisition methods
| somascan | olink | Different affinity platforms
| human | vertebrates | Different organism types
| human | invertebrates | Different organism types
| human | plants | Different organism types
| vertebrates | invertebrates | Different organism types
| vertebrates | plants | Different organism types
| invertebrates | plants | Different organism types
|===

== YAML Template Schema

=== Complete Template Structure

[source,yaml]
----
# =============================================================================
# TEMPLATE METADATA (required)
# =============================================================================
name: human                        # Unique template identifier (used in --template flag)
description: Human SDRF template   # Human-readable description
version: 1.1.0                     # Semantic version (major.minor.patch)

# =============================================================================
# INHERITANCE AND RELATIONSHIPS (optional)
# =============================================================================
extends: base                      # Parent template to inherit from
usable_alone: false                # Can this template be used without others?
layer: sample                      # Layer: base, technology, sample, experiment

# Mutual exclusivity - templates that cannot be combined with this one
mutually_exclusive_with:
  - vertebrates
  - invertebrates
  - plants

# Required layers - for templates that need specific layer types
requires:
  - layer: technology              # Requires a technology template
  - layer: sample                  # Requires a sample template

# =============================================================================
# TEMPLATE-LEVEL VALIDATORS (optional)
# =============================================================================
validators:
  - validator_name: min_columns
    params:
      min_columns: 12
  - validator_name: trailing_whitespace_validator
    params: {}

# =============================================================================
# COLUMN DEFINITIONS (required)
# =============================================================================
columns:
  - name: characteristics[disease]
    description: Disease state of the sample
    requirement: required          # required | recommended | optional
    type: string                   # string | integer (default: string)
    cardinality: single            # single | multiple (default: single)
    allow_not_applicable: true     # Allow "not applicable" value
    allow_not_available: true      # Allow "not available" value
    allow_pooled: false            # Allow "pooled" value (for replicates)
    validators:
      - validator_name: ontology
        params:
          ontologies:
            - mondo
            - efo
            - doid
            - pato
          error_level: warning     # error | warning
          description: The disease should be a valid ontology term
          examples:
            - normal
            - breast cancer
            - diabetes mellitus
----

=== Template Properties Reference

[cols="2,1,1,4", options="header"]
|===
| Property | Required | Type | Description

| `name`
| Yes
| string
| Unique template identifier. Used in validation commands (`--template human`).

| `description`
| Yes
| string
| Human-readable description of the template's purpose.

| `version`
| Yes
| string
| Semantic version (e.g., `1.1.0`). Should match the specification version.

| `extends`
| No
| string
| Parent template name. Child inherits all columns and validators.

| `usable_alone`
| No
| boolean
| If `false`, must be combined with other templates. Default: `true`.

| `layer`
| No
| string
| Template layer: `base`, `technology`, `sample`, or `experiment`.

| `mutually_exclusive_with`
| No
| list
| Templates that cannot be combined with this one.

| `requires`
| No
| list
| Layer requirements (e.g., `- layer: technology`).

| `validators`
| No
| list
| Template-level validators applied to the entire SDRF file.

| `columns`
| Yes
| list
| Column definitions with validation rules.
|===

=== Column Properties Reference

[cols="2,1,1,4", options="header"]
|===
| Property | Required | Type | Description

| `name`
| Yes
| string
| Column header exactly as in SDRF (e.g., `characteristics[disease]`).

| `description`
| Yes
| string
| What the column contains and how to fill it.

| `requirement`
| Yes
| string
| `required` (must be present), `recommended` (should be present), `optional` (may be present).

| `type`
| No
| string
| Data type: `string` (default) or `integer`.

| `cardinality`
| No
| string
| `single` (default) or `multiple` (semicolon-separated values).

| `allow_not_applicable`
| No
| boolean
| Allow `not applicable` when column doesn't apply. Default: `false`.

| `allow_not_available`
| No
| boolean
| Allow `not available` when data is unknown. Default: `false`.

| `allow_pooled`
| No
| boolean
| Allow `pooled` value (for biological replicate). Default: `false`.

| `validators`
| No
| list
| Column-level validators for value checking.
|===

== Validator Reference

=== Template-Level Validators

These validators apply to the entire SDRF file structure.

==== min_columns

Ensures minimum column count.

[source,yaml]
----
- validator_name: min_columns
  params:
    min_columns: 12
----

==== trailing_whitespace_validator

Checks for trailing whitespace in cell values.

[source,yaml]
----
- validator_name: trailing_whitespace_validator
  params: {}
----

==== column_order

Validates expected column order (source name first, data file last).

[source,yaml]
----
- validator_name: column_order
  params: {}
----

==== empty_cells

Checks for empty cells that should have values.

[source,yaml]
----
- validator_name: empty_cells
  params: {}
----

==== combination_of_columns_no_duplicate_validator

Ensures column combinations are unique (no duplicate rows).

[source,yaml]
----
- validator_name: combination_of_columns_no_duplicate_validator
  params:
    column_name:              # Must be unique (error if duplicates)
      - source name
      - assay name
      - comment[label]
    column_name_warning:      # Should be unique (warning if duplicates)
      - source name
      - assay name
----

=== Column-Level Validators

These validators apply to individual column values.

==== ontology

Validates values against ontology terms.

[source,yaml]
----
- validator_name: ontology
  params:
    ontologies:              # List of ontology prefixes
      - mondo
      - efo
      - doid
    parent_term: MS:1000044  # Optional: restrict to children of this term
    error_level: warning     # error or warning
    description: Human-readable validation message
    examples:
      - normal
      - breast cancer
----

==== pattern

Validates values against a regular expression.

[source,yaml]
----
- validator_name: pattern
  params:
    pattern: ^(\d+[yYmMdD])+(-(\d+[yYmMdD])+)?$
    case_sensitive: false    # Optional, default: true
    description: Age format like 45Y, 6M, 30Y6M
    examples:
      - 45Y
      - 30Y6M
      - 40Y-50Y
----

==== values

Validates against a fixed list of allowed values.

[source,yaml]
----
- validator_name: values
  params:
    values:
      - male
      - female
      - intersex
      - not available
      - not applicable
    error_level: error
    description: Sex must be one of the allowed values
----

==== single_cardinality_validator

Ensures single value per cell (no semicolon-separated values).

[source,yaml]
----
- validator_name: single_cardinality_validator
  params: {}
----

== Supported Ontologies

[cols="1,3,3", options="header"]
|===
| Prefix | Ontology | Common Use

| `ncbitaxon` | NCBI Taxonomy | organism
| `uberon` | Uberon Anatomy Ontology | organism part
| `cl` | Cell Ontology | cell type
| `clo` | Cell Line Ontology | cell line
| `bto` | BRENDA Tissue Ontology | tissue, cell type, cell line
| `mondo` | MONDO Disease Ontology | disease
| `efo` | Experimental Factor Ontology | disease, experimental factors
| `doid` | Disease Ontology | disease
| `pato` | Phenotype and Trait Ontology | phenotypes (including "normal")
| `ms` | PSI-MS Ontology | instrument, cleavage agent, mass analyzer
| `pride` | PRIDE Ontology | acquisition method, labels, affinity instruments
| `unimod` | UNIMOD | post-translational modifications
| `xlmod` | XLMOD | crosslinking reagents
| `hancestro` | Human Ancestry Ontology | ancestry category (human)
| `hsapdv` | Human Developmental Stages | developmental stage (human)
| `mmusdv` | Mouse Developmental Stages | developmental stage (mouse)
| `fbdv` | FlyBase Developmental | developmental stage (Drosophila)
| `wbls` | WormBase Life Stage | developmental stage (C. elegans)
| `po` | Plant Ontology | plant tissues, developmental stages
| `envo` | Environment Ontology | environmental samples (metaproteomics)
| `gaz` | Gazetteer | geographic locations
| `chebi` | ChEBI | chemical entities, treatments
|===

== Template Inheritance Rules

When templates are combined, the following rules apply:

=== Inheritance Behavior

1. **Column inheritance**: Child templates inherit all columns from parent templates
2. **Validator inheritance**: Child templates inherit all validators from parent templates
3. **Column override**: Child templates can redefine inherited columns with stricter requirements

=== Requirement Strengthening

Child templates may **strengthen** but not weaken requirements:

[cols="2,2,2", options="header"]
|===
| Parent Requirement | Allowed in Child | Not Allowed

| `optional`
| `optional`, `recommended`, `required`
| -

| `recommended`
| `recommended`, `required`
| `optional`

| `required`
| `required`
| `optional`, `recommended`
|===

=== Multi-Template Combination

When multiple templates are combined:

1. All columns from all templates are included
2. If the same column appears in multiple templates, the **strictest requirement** wins
3. Validators are merged (all validators apply)
4. Mutual exclusivity is checked first

**Example valid combination:**
[source]
----
ms-proteomics + human + dda-acquisition + cell-lines
     ↓             ↓           ↓              ↓
 technology    sample    experiment     experiment
----

== Creating a New Template: Step-by-Step Guide

This section walks through creating a new YAML template from scratch. The example creates a hypothetical `top-down` template for top-down proteomics experiments.

=== Step 1: Choose the Parent Template

Every template (except `base`) must extend a parent. Choose based on where your template fits in the hierarchy:

[cols="2,3,2", options="header"]
|===
| You are defining... | Extend | Layer

| A new proteomics technology (rare)
| `base`
| `technology`

| A new organism type
| `base`
| `sample`

| A new MS experiment type
| `ms-proteomics`
| `experiment`

| A new affinity experiment type
| `affinity-proteomics`
| `experiment`
|===

For our example, top-down proteomics is a mass spectrometry technique, so we extend `ms-proteomics` and use the `experiment` layer.

=== Step 2: Create the Directory Structure

Templates live in the https://github.com/bigbio/sdrf-templates[sdrf-templates] repository. Each template has a versioned directory:

[source]
----
sdrf-templates/
└── top-down/
    └── 1.0.0-dev/
        ├── top-down.yaml         # Template schema (required)
        └── top-down.sdrf.tsv     # Example SDRF file (required)
----

Use the `-dev` suffix for the initial version until the template is reviewed and accepted by the community.

=== Step 3: Write the YAML Schema

Start with the template metadata, then define the columns your experiment type needs. Only define columns that are **new or different** from the parent — inherited columns from `ms-proteomics` do not need to be repeated.

.top-down/1.0.0-dev/top-down.yaml
[source,yaml]
----
# ===========================================================================
# TEMPLATE METADATA
# ===========================================================================
name: top-down
description: >
  SDRF template for top-down proteomics experiments where intact proteins
  are analyzed without prior enzymatic digestion. Extends ms-proteomics
  with top-down-specific columns for intact mass analysis.
version: 1.0.0-dev
extends: ms-proteomics
usable_alone: false
layer: experiment

# ===========================================================================
# COLUMN DEFINITIONS — only columns new or changed from parent
# ===========================================================================
columns:

  # --- New column: protein separation method ---
  - name: comment[protein separation method]
    description: >
      Method used to separate intact proteins before MS analysis
      (e.g., GELFrEE, SEC, RPLC, CZE). Use "not applicable" if no
      separation was performed (direct infusion).
    requirement: recommended
    allow_not_applicable: true
    allow_not_available: true
    validators:
      - validator_name: ontology
        params:
          ontologies:
            - ms
            - pride
          error_level: warning
          description: >
            Protein separation method should be a valid PSI-MS or PRIDE
            ontology term.
          examples:
            - size exclusion chromatography
            - gel electrophoresis
            - capillary zone electrophoresis
            - reversed-phase liquid chromatography
            - not applicable

  # --- New column: intact mass range ---
  - name: comment[precursor mass range]
    description: >
      The mass range of intact protein precursors analyzed, in Daltons.
      Format: "min-max Da" (e.g., "5000-50000 Da").
    requirement: optional
    allow_not_available: true
    validators:
      - validator_name: pattern
        params:
          pattern: ^(\d+-\d+\s*Da|not available)$
          case_sensitive: false
          description: >
            Precursor mass range in format "min-max Da".
          examples:
            - 5000-50000 Da
            - 10000-100000 Da
            - not available

  # --- Override inherited column: make cleavage agent "not applicable" ---
  # In top-down experiments, proteins are not digested, so the cleavage
  # agent column should always be "not applicable". We override the
  # inherited column to make this explicit.
  - name: comment[cleavage agent details]
    description: >
      Cleavage agent is not applicable for top-down experiments where
      intact proteins are analyzed. Use "not applicable".
    requirement: required
    allow_not_applicable: true
    allow_not_available: false
    validators:
      - validator_name: values
        params:
          values:
            - not applicable
          error_level: warning
          description: >
            Top-down experiments analyze intact proteins. Cleavage agent
            should be "not applicable".
----

Key points demonstrated in this example:

* **New columns** (`comment[protein separation method]`, `comment[precursor mass range]`) are defined with their own validators.
* **Overriding an inherited column** (`comment[cleavage agent details]`) restricts the parent's definition — in this case, forcing the value to "not applicable" since top-down experiments don't use enzymatic digestion.
* **Descriptions explain the "why"** — not just what the field is, but when to use `not applicable` and what format to follow.
* **Examples are always provided** in validators — they serve as documentation and can be used by tools to generate autocomplete suggestions.

=== Step 4: Create an Example SDRF File

Every template must include an example `.sdrf.tsv` file that passes validation. This file demonstrates correct usage and serves as a starting point for users.

.top-down/1.0.0-dev/top-down.sdrf.tsv (tab-separated)
[source,tsv]
----
source name	characteristics[organism]	characteristics[organism part]	characteristics[disease]	characteristics[biological replicate]	assay name	technology type	comment[proteomics data acquisition method]	comment[label]	comment[instrument]	comment[cleavage agent details]	comment[fraction identifier]	comment[technical replicate]	comment[data file]	comment[protein separation method]	comment[precursor mass range]	factor value[disease]
sample_1	homo sapiens	heart	normal	1	run_1	proteomic profiling by mass spectrometry	data-dependent acquisition	label free sample	LTQ Orbitrap Elite	not applicable	1	1	sample_1.raw	gel electrophoresis	10000-100000 Da	normal
sample_2	homo sapiens	heart	dilated cardiomyopathy	1	run_2	proteomic profiling by mass spectrometry	data-dependent acquisition	label free sample	LTQ Orbitrap Elite	not applicable	1	1	sample_2.raw	gel electrophoresis	10000-100000 Da	dilated cardiomyopathy
----

=== Step 5: Create the Documentation

Add a `README.adoc` file in the specification repository under `sdrf-proteomics/templates/top-down/`:

.sdrf-proteomics/templates/top-down/README.adoc (outline)
[source,asciidoc]
----
= Top-Down Proteomics Template

== Overview
[describe when to use this template]

== Columns
[table of columns with requirement levels, descriptions, and examples]

== Examples
[link to the example SDRF file]

== See Also
* link:../../README.adoc[SDRF-Proteomics Specification]
* link:../ms-proteomics/README.adoc[MS-Proteomics Template] (parent)
----

=== Step 6: Test Locally

Before submitting, validate your example file against your template:

[source,bash]
----
# Install or upgrade the validator
pip install sdrf-pipelines

# Validate the example SDRF file with the new template
parse_sdrf validate-sdrf \
  --sdrf_file top-down/1.0.0-dev/top-down.sdrf.tsv \
  --template ms-proteomics \
  --custom_template top-down/1.0.0-dev/top-down.yaml
----

Check that:

* [ ] The example file passes validation with no errors.
* [ ] All required columns from the parent template are present.
* [ ] New columns validate correctly (ontology terms resolve, patterns match).
* [ ] The `not applicable` and `not available` values work where expected.

=== Step 7: Submit a Pull Request

Submit the template to the https://github.com/bigbio/sdrf-templates[sdrf-templates] repository via pull request. The PR must include:

1. The YAML schema file (`top-down/1.0.0-dev/top-down.yaml`).
2. The example SDRF file (`top-down/1.0.0-dev/top-down.sdrf.tsv`).
3. A PR description explaining: what experiment type the template covers, why it is needed, and which parent it extends.

The corresponding `README.adoc` documentation goes into a separate PR to the https://github.com/bigbio/proteomics-metadata-standard[specification repository] under `sdrf-proteomics/templates/top-down/`.

Once reviewed and merged, the template appears in the `templates.yaml` manifest and becomes available to all users of sdrf-pipelines. The `-dev` suffix is removed when the template is promoted to a stable release (e.g., `1.0.0`).

=== Quick Reference: Template YAML Checklist

[cols="1,3", options="header"]
|===
| Field | Checklist

| `name`
| Lowercase with hyphens. Unique across all templates.

| `description`
| One or two sentences. Mention what it extends and what experiment type it covers.

| `version`
| Use `X.Y.Z-dev` for new templates. Remove `-dev` after community review.

| `extends`
| Must be an existing template name (`ms-proteomics`, `affinity-proteomics`, or `base`).

| `layer`
| One of: `technology`, `sample`, `experiment`.

| `usable_alone`
| Almost always `false` for experiment and sample layer templates.

| `columns`
| Only define columns that are **new** or that **override** a parent column. Do not repeat inherited columns unchanged.

| Validators
| Use `ontology` for controlled vocabularies, `pattern` for structured text, `values` for fixed lists. Always include `examples`.

| Reserved words
| Set `allow_not_applicable`, `allow_not_available`, `allow_pooled`, `allow_anonymized` as appropriate for each column.
|===

=== Best Practices

- **Only define what is new.** Inherited columns from the parent template do not need to be repeated. Only add a column to your template if it is new or if you need to override the parent's definition (e.g., change `requirement` from `optional` to `required`, or restrict allowed values).
- **Use ontologies over patterns.** Prefer `ontology` validators for fields where controlled vocabulary terms exist. Use `pattern` validators only for structured free text (ages, mass ranges, file names).
- **Provide clear descriptions.** Explain not just what the field is, but when to use `not applicable` vs `not available`, and give format guidance.
- **Always include examples.** Examples in validators serve as documentation and help tools generate suggestions.
- **Test with real data.** Your example SDRF should represent a realistic experiment, not a toy file. If possible, base it on a real public dataset.

== Validation Commands

Validate SDRF files using sdrf-pipelines:

[source,bash]
----
# Install
pip install sdrf-pipelines

# Validate with single template
parse_sdrf validate-sdrf --sdrf_file file.sdrf.tsv --template ms-proteomics

# Validate with multiple templates
parse_sdrf validate-sdrf --sdrf_file file.sdrf.tsv \
  --template ms-proteomics \
  --template human \
  --template dda-acquisition

# Check template compatibility
parse_sdrf check-templates --templates ms-proteomics,human,dda-acquisition
----

== References

- https://github.com/bigbio/sdrf-pipelines[sdrf-pipelines] - SDRF validation tool
- https://github.com/bigbio/proteomics-metadata-standard/tree/master/sdrf-proteomics/templates[Template files on GitHub]
- link:../README.adoc[SDRF-Proteomics Specification]
