name: Build and Deploy Documentation

on:
  push:
    branches:
      - master
      - dev
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ubuntu-latest
    name: Build AsciiDoc documentation site

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install Asciidoctor
        run: |
          gem install asciidoctor
          gem install asciidoctor-diagram

      - name: Set output directory based on branch
        id: set-output-dir
        run: |
          if [ "${{ github.ref_name }}" == "master" ]; then
            echo "output_dir=docs" >> $GITHUB_OUTPUT
            echo "base_url=" >> $GITHUB_OUTPUT
          else
            echo "output_dir=docs/dev" >> $GITHUB_OUTPUT
            echo "base_url=/dev" >> $GITHUB_OUTPUT
          fi

      - name: Create output directory
        run: mkdir -p ${{ steps.set-output-dir.outputs.output_dir }}

      - name: Build main specification
        run: |
          asciidoctor \
            -D ${{ steps.set-output-dir.outputs.output_dir }} \
            -a stylesheet=css/style.css \
            -a linkcss \
            -a toc=left \
            -a toclevels=3 \
            -a sectanchors \
            -a sectlinks \
            -a source-highlighter=highlight.js \
            --backend=html5 \
            -o specification.html \
            sdrf-proteomics/README.adoc

      - name: Build tool support page
        run: |
          asciidoctor \
            -D ${{ steps.set-output-dir.outputs.output_dir }} \
            -a stylesheet=css/style.css \
            -a linkcss \
            -a toc=left \
            -a toclevels=3 \
            -a sectanchors \
            -a sectlinks \
            -a source-highlighter=highlight.js \
            --backend=html5 \
            -o tool-support.html \
            sdrf-proteomics/tool-support.adoc

      - name: Build annotation guidelines
        run: |
          mkdir -p ${{ steps.set-output-dir.outputs.output_dir }}/metadata-guidelines

          # Sample metadata rules
          asciidoctor \
            -D ${{ steps.set-output-dir.outputs.output_dir }}/metadata-guidelines \
            -a stylesheet=../css/style.css \
            -a linkcss \
            -a toc=left \
            -a toclevels=3 \
            -a sectanchors \
            -a sectlinks \
            --backend=html5 \
            -o sample-metadata.html \
            sdrf-proteomics/metadata-guidelines/sample-metadata.adoc

          # Human sample metadata rules
          asciidoctor \
            -D ${{ steps.set-output-dir.outputs.output_dir }}/metadata-guidelines \
            -a stylesheet=../css/style.css \
            -a linkcss \
            -a toc=left \
            -a toclevels=3 \
            -a sectanchors \
            -a sectlinks \
            --backend=html5 \
            -o human-metadata.html \
            sdrf-proteomics/metadata-guidelines/human-sample-metadata.adoc

          # Data file metadata rules
          asciidoctor \
            -D ${{ steps.set-output-dir.outputs.output_dir }}/metadata-guidelines \
            -a stylesheet=../css/style.css \
            -a linkcss \
            -a toc=left \
            -a toclevels=3 \
            -a sectanchors \
            -a sectlinks \
            --backend=html5 \
            -o data-file-metadata.html \
            sdrf-proteomics/metadata-guidelines/data-file-metadata.adoc

      - name: Build templates documentation
        run: |
          mkdir -p ${{ steps.set-output-dir.outputs.output_dir }}/templates

          # Find and build all README.adoc files in templates directory
          for dir in sdrf-proteomics/templates/*/; do
            if [ -f "${dir}README.adoc" ]; then
              template_name=$(basename "$dir")
              asciidoctor \
                -D ${{ steps.set-output-dir.outputs.output_dir }}/templates \
                -a stylesheet=../css/style.css \
                -a linkcss \
                -a toc=left \
                -a toclevels=3 \
                -a sectanchors \
                -a sectlinks \
                --backend=html5 \
                -o "${template_name}.html" \
                "${dir}README.adoc"
            fi
          done

      - name: Copy assets
        run: |
          # Copy images
          mkdir -p ${{ steps.set-output-dir.outputs.output_dir }}/images
          cp -r sdrf-proteomics/images/* ${{ steps.set-output-dir.outputs.output_dir }}/images/ 2>/dev/null || true
          cp -r images/* ${{ steps.set-output-dir.outputs.output_dir }}/images/ 2>/dev/null || true

          # Copy CSS
          mkdir -p ${{ steps.set-output-dir.outputs.output_dir }}/css
          cp site/css/style.css ${{ steps.set-output-dir.outputs.output_dir }}/css/

      - name: Copy index, navigation, and JavaScript
        run: |
          cp site/index.html ${{ steps.set-output-dir.outputs.output_dir }}/
          mkdir -p ${{ steps.set-output-dir.outputs.output_dir }}/js
          cp site/js/search.js ${{ steps.set-output-dir.outputs.output_dir }}/js/

      - name: Copy SDRF Terms Reference page
        run: |
          cp site/sdrf-terms.html ${{ steps.set-output-dir.outputs.output_dir }}/
          cp sdrf-proteomics/metadata-guidelines/sdrf-terms.tsv ${{ steps.set-output-dir.outputs.output_dir }}/

      - name: Copy Quick Start page
        run: |
          cp site/quickstart.html ${{ steps.set-output-dir.outputs.output_dir }}/

      - name: Build SDRF Explorer index
        run: |
          python3 site/build-sdrf-index.py
          cp site/sdrf-data.json ${{ steps.set-output-dir.outputs.output_dir }}/
          cp site/sdrf-explorer.html ${{ steps.set-output-dir.outputs.output_dir }}/

      - name: Add navigation header to documentation pages
        run: |
          OUTPUT_DIR="${{ steps.set-output-dir.outputs.output_dir }}"

          # Create Python script to inject headers
          cat > /tmp/inject_header.py << 'PYEOF'
          import sys
          import re

          filepath = sys.argv[1]
          header_html = sys.argv[2]

          with open(filepath, 'r') as f:
              content = f.read()

          # Add has-doc-header class to body
          content = re.sub(r'<body class="([^"]*)"', r'<body class="has-doc-header \1"', content)
          content = re.sub(r'<body>', '<body class="has-doc-header">', content)

          # Insert header after opening body tag
          content = re.sub(r'(<body[^>]*>)', r'\1\n' + header_html, content)

          with open(filepath, 'w') as f:
              f.write(content)
          PYEOF

          # Header for root-level pages (specification.html)
          ROOT_HEADER='<header class="doc-header"><div class="doc-header-brand"><a href="./index.html">SDRF-Proteomics</a></div><nav class="doc-header-nav"><a href="./index.html">Home</a><a href="./specification.html" class="nav-current">Specification</a><a href="./index.html#metadata-guidelines">Metadata Guidelines</a><a href="./index.html#templates">Templates</a><a href="./index.html#tools">Tools</a><a href="./sdrf-explorer.html">Explorer</a><a href="./index.html#contributors">Contributors</a><a href="/dev/" class="version-link">Dev Version</a><a href="https://github.com/bigbio/proteomics-metadata-standard" target="_blank">GitHub</a></nav></header>'

          # Header for tool support page
          TOOLS_HEADER='<header class="doc-header"><div class="doc-header-brand"><a href="./index.html">SDRF-Proteomics</a></div><nav class="doc-header-nav"><a href="./index.html">Home</a><a href="./specification.html">Specification</a><a href="./index.html#metadata-guidelines">Metadata Guidelines</a><a href="./index.html#templates">Templates</a><a href="./index.html#tools" class="nav-current">Tools</a><a href="./sdrf-explorer.html">Explorer</a><a href="./index.html#contributors">Contributors</a><a href="/dev/" class="version-link">Dev Version</a><a href="https://github.com/bigbio/proteomics-metadata-standard" target="_blank">GitHub</a></nav></header>'

          # Header for annotation guidelines pages
          GUIDELINES_HEADER='<header class="doc-header"><div class="doc-header-brand"><a href="../index.html">SDRF-Proteomics</a></div><nav class="doc-header-nav"><a href="../index.html">Home</a><a href="../specification.html">Specification</a><a href="../index.html#metadata-guidelines" class="nav-current">Metadata Guidelines</a><a href="../index.html#templates">Templates</a><a href="../index.html#tools">Tools</a><a href="../sdrf-explorer.html">Explorer</a><a href="../index.html#contributors">Contributors</a><a href="/dev/" class="version-link">Dev Version</a><a href="https://github.com/bigbio/proteomics-metadata-standard" target="_blank">GitHub</a></nav></header>'

          # Header for template pages
          TMPL_HEADER='<header class="doc-header"><div class="doc-header-brand"><a href="../index.html">SDRF-Proteomics</a></div><nav class="doc-header-nav"><a href="../index.html">Home</a><a href="../specification.html">Specification</a><a href="../index.html#metadata-guidelines">Metadata Guidelines</a><a href="../index.html#templates" class="nav-current">Templates</a><a href="../index.html#tools">Tools</a><a href="../sdrf-explorer.html">Explorer</a><a href="../index.html#contributors">Contributors</a><a href="/dev/" class="version-link">Dev Version</a><a href="https://github.com/bigbio/proteomics-metadata-standard" target="_blank">GitHub</a></nav></header>'

          # Add header to specification.html
          if [ -f "$OUTPUT_DIR/specification.html" ]; then
            python3 /tmp/inject_header.py "$OUTPUT_DIR/specification.html" "$ROOT_HEADER"
          fi

          # Add header to tool-support.html
          if [ -f "$OUTPUT_DIR/tool-support.html" ]; then
            python3 /tmp/inject_header.py "$OUTPUT_DIR/tool-support.html" "$TOOLS_HEADER"
          fi

          # Add header to annotation guidelines pages
          for file in "$OUTPUT_DIR"/metadata-guidelines/*.html; do
            if [ -f "$file" ]; then
              python3 /tmp/inject_header.py "$file" "$GUIDELINES_HEADER"
            fi
          done

          # Add header to template pages
          for file in "$OUTPUT_DIR"/templates/*.html; do
            if [ -f "$file" ]; then
              python3 /tmp/inject_header.py "$file" "$TMPL_HEADER"
            fi
          done

      - name: Transform SDRF links to use viewer
        run: |
          # Replace GitHub links to annotated-projects with SDRF Explorer viewer links
          # Pattern: https://github.com/bigbio/proteomics-metadata-standard/tree/master/annotated-projects/PXD... -> ./sdrf-explorer.html?view=PXD...
          python3 << 'EOF'
          import re

          filepath = "${{ steps.set-output-dir.outputs.output_dir }}/specification.html"
          with open(filepath, 'r') as f:
              content = f.read()

          # Replace GitHub annotated-projects links with SDRF Explorer viewer links
          pattern = r'href="https://github\.com/bigbio/proteomics-metadata-standard/tree/master/annotated-projects/(PXD\d+)"'
          replacement = r'href="./sdrf-explorer.html?view=\1"'
          content = re.sub(pattern, replacement, content)

          with open(filepath, 'w') as f:
              f.write(content)

          print("Transformed SDRF links to use viewer in specification.html")
          EOF

      - name: Build search index
        run: |
          python3 site/build-search-index.py . ${{ steps.set-output-dir.outputs.output_dir }}/search-index.json

      - name: Add version banner for dev branch
        if: github.ref_name == 'dev'
        run: |
          # Add a banner to index.html indicating this is the dev version
          sed -i 's/<body>/<body><div class="dev-banner">⚠️ Development Version - This documentation is from the dev branch and may contain unreleased changes. <a href="\/">View stable version<\/a><\/div>/' ${{ steps.set-output-dir.outputs.output_dir }}/index.html

      - name: Add dev banner styles
        if: github.ref_name == 'dev'
        run: |
          echo '
          /* Dev banner */
          .dev-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.9rem;
            border-bottom: 1px solid #fcd34d;
          }
          .dev-banner a {
            color: #92400e;
            font-weight: 600;
          }
          ' >> ${{ steps.set-output-dir.outputs.output_dir }}/css/style.css

      - name: Checkout gh-pages branch for merging
        if: github.ref_name == 'dev'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-existing

      - name: Merge dev docs into existing gh-pages
        if: github.ref_name == 'dev'
        run: |
          # Copy existing gh-pages content (master version)
          mkdir -p final-docs
          cp -r gh-pages-existing/* final-docs/ 2>/dev/null || true
          # Remove old dev folder if exists
          rm -rf final-docs/dev
          # Copy new dev docs
          cp -r docs/dev final-docs/dev
          # Move final-docs to docs for deployment
          rm -rf docs
          mv final-docs docs

      - name: Add CNAME for custom domain
        run: echo 'sdrf.quantms.org' > docs/CNAME

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./docs/
